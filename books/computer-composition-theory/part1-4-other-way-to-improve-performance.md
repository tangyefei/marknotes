## 04. 穿越“功耗”墙，我们该从哪些方面提升性能

上一节介绍CPU性能的时候，介绍了这么一个公式：

```
程序的CPU执行时间=指令数*CPI*Clock Cycle Time
```

要搞定指令数和CPI都不太容易，因此时钟频率就成了主要的优化对象。从最早1978年Intel发布的8086 CPU开始，计算机的主频从5MHz，不断提升，Intel更是夸下海口，CPU的结构可以做到10GHz。

### 1. 功耗：CPU的“人体极限”

事实最新的CPU的主频并没有“大力出奇迹”，1978年到2000年，提升了300倍；而到2000年到2020年，提升了大概3倍。究其原因，就是功耗问题。

一个3.8GHz的奔腾4处理器，满载功耗是130瓦，而iPhone X使用的ARM架构的CPU，功率则只有4.5瓦。同样的电池容量，功耗越大，能使用的时长越短。

### 2. 如何降低功耗

CPU一般被称作超大规模集成电路，它们由晶体组成，计算的过程就是不断“打开”和“关闭”开关来完成各种运算和功能。

想要计算的得快，一方面增加晶体管的数量，也就是增加密度；另外一方面，让开关“打开”和“关闭”得更快一点，也就是提升主频。

两者都会带来功耗的问题，做一个形象的比喻，前者就像是工厂增加了更多的工人，后者好比是使用更加熟练的工人。自然人更多、进行更有强度的工作，都会打来更多的热量消耗。因此可以通过使用各种散热手段，但是散热效果毕竟也是有极限的。

在介绍如何降低功耗之前，我们先看下面这么一个公式：

```
功耗~=1/2 * 负载电容 * 电压的平方 * 开关频率 * 晶体管数量
```

为了提升性能，我们增加了更多的工人，即制造和使用了更多更小的晶体管（通常所说的提升“制程”），为了降低功耗，我们可以把电压减低，电压减低到原先的1/5，整个功耗就会变成原先的1/25。

事实上，从5MHz主频的8086到5GHz主频的Intel i9，主频提升了1000倍，但是功耗却之增长了40倍， 愿意就是CPU电压也从5V下降到了1V。

### 3. 阿姆达尔定律

通过提升主频已经比较难以提升性能，开始推出了多核的CPU，相当于提高“吞吐量”而不是“响应时间”来达到目的。

但是并不是所有的问题都可以通过多核并行计算来解决，必须要满足如下几个条件：

1. 需要进行的计算，可以分解为可并行的任务。
2. 需要能分解好问题，确保结果可以汇总到一起。
3. 汇总阶段还是需要顺序执行，没法并行。

这就引出了性能优化中的经验定律：阿姆达尔定律，它说的是，对一个程序的优化，并行运算后的效率的提升情况，可以用如下的公式来表示：

```
优化后的执行时间=受优化影响的执行时间/加速倍数+不受影响的执行时间。
```

### 4. 总结延伸

除了“摩尔定律”和“并行计算”之外，还有这样几个提升性能的方法：

1. 加速概率事件，最典型的是流行的深度学习，因为计算99%是向量和矩阵，工程师使用GPU替代CPU，大幅提升了深度学习的模型训练过程。
2. 通过流水线提高性能，即想任务拆分成了细分的任务，后续会介绍它是如何提高性能，有带来了功耗和效率的负面影响的。
3. 通过预测提高性能，提前猜测到下一步告诉什么，并进行提前运算，后续会降到的“分支与冒泡”，“局部性原理”其实都是利用了对未来的预测。


综上，第3、4节都是组成原理课程的前情提要，一方面，整个组成乃至体系结构都是基于冯诺依曼体系结构，另一方面，种种的设计和考虑，除了体系结构的抽象和通用性之外，核心考虑是“性能”。接下来将要开始深入组成原理的学习。








