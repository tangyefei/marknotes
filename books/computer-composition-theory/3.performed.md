## 03 通过你的CPU主频，我们谈谈“性能”究竟是什么


### 1.什么是性能

计算机的性能和干体力劳动很像，就好比搬东西，有两个衡量标准：

- 响应时间，Response time 或 Execution time
- 吞吐量，Throughput 或 Bandwidth


提高吞吐率的办法有很多，多加一些机器，多堆一些硬件就好了，但是响应时间提升却很难。

一般吧性能定义成响应时间的倒数：

```
性能 = 1 / 响应时间
```

一段程序在两个CPU的运行时间为1/30秒、1/60秒，则说后者性能是前者的2倍。

流行的跑分就是把预先设置好的程序在手机上执行，然后根据所需要的时间得出一个分数。

在业界，各大CPU和服务器厂商组织了一个叫SPEC的第三方机构，专门用来指定各种跑分规则。

### 2. 计算机的计时单位

使用时间来衡量性能的指标，存在两个问题：

#### 2.1. 第一个是不准

CPU在不同的程序之间切换，并且还可能从硬盘网络等地方读取数据，因此实际的执行时间应该将这些读取、切换等时间刨掉。在Linux中使用time命令，可以看到返回的三个值：

- real time，即Wall Clock Time整个程序运行所流逝掉的时间
- user time，程序在运行你的程序所用的时间
- sys time，在操作系统内合理运行指令的时间

程序实际花费的CPU时间，就是user time加上sys time。

#### 2.2 第二个是CPU运行状态不一

CPU可能满载运行，也可能降频运行，降频运行的时候自然会花费更多的时间。

除此之外，性能指标还受到主板、内存等其他硬件的影响。


### 3.CPU时钟 

我们进一步把CPU的执行时间变成：

```
程序的CPU执行时间 = CPU时钟周期数（CPU Cycles） * 时钟周期时间（Clock Cycle Time）
```

#### 3.1 时钟周期时间

假定买一台电脑，它的CPU为 Intel Core-i7 2.8GHz，2.8GHz代表着电脑的主频（Frequency/Clock Rate），可以粗浅地理解为计算机在1秒时间内可以执行的指令数量是2.8G条。

CPU内部有一个晶体振荡器，简称晶振，可以把它当成一个CPU内部的电子表，每一次“滴答”就是时钟周期时间，就是 1/2.8G。

我们的CPU就是安好这个“时钟”的提示来进行资金的操作，主频越高，意味着这个时钟走的越快，当然快的代价就是散热的压力会很大，超过极限就会崩溃。“超频”的概念就是把CPU的内部时钟给调快了。

#### 3.2 CPU时钟周期数

更换CPU来提高主频，也即是换一块好一点CPU，这通常不是我们能决定的。因此，我们如果能够减少程序运行的CPU时钟周期数，一样能够提高程序性能。将它进一步分解，又可以表示为：

```
指令数 * 每条指令的平均周期数（Cycles Per Instruction，简称CPI）
```

不同的指令需要的Cycles是不同的，加法和乘法都对应着一条CPU指令，乘法需要的Cycles就比加法多。这样经过拆分后，我们的CPU执行时间最终就成了：

```
程序的CPU执行时间 = 指令数 * CPI * Clock Cycle Time
```

#### 3.3 优化策略

想要解决性能问题，其实就是优化这三者：

- 时钟周期时间，即计算机主频，取决于计算机硬件，摩尔定律就是不停地在提高我们的主频
- 每条指令的平均时钟周期数（CPI），现代技术让每一条指令需要的CPU Cycles尽可能少
- 指令数，即程序到底需要多少指令、用那些指令，同样的代码，不同的编译器会有不同的表示方式















































