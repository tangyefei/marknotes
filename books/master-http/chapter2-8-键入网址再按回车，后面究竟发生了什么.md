# 8 键入网址再按回车，后面究竟发生了什么

## 使用IP地址访问Web服务器

打开抓包工具，然后通过 httP://127.0.0.1访问。

可以看到服务器端口80，浏览器端口53102，如下是抓到的包（还有一些其他的包被混入了，暂时只摘取最重要的）进行介绍。


1. 浏览器 -> 服务器 SYN
2. 服务器 -> 浏览器 SYN ACK
3. 浏览器 -> 服务器 ACK
4. 浏览器 -> 服务器 GET / HTTP/1.1
5. 服务器 -> 浏览器 ACK
6. 服务器 -> 浏览器 HTTP/1.1 200 OK(text/html)
7. 浏览器 -> 服务器 ACK
8. 浏览器 -> 服务器 GET /favicon HTTP/1.1
9. 服务器 -> 浏览器 ACK
10. 服务器 -> 浏览器 HTTP/1.1 404 Not Found
11. 浏览器 -> 服务器 ACK	
	
	
	

首先是1-3，经过三次握手后，浏览器与服务器的连接 就建立起来了。

然后是4-7的步骤一次是，浏览器通过TCP发送了一个请求报文，服务器发送一个ACK告诉浏览器”你的请求我收到了“，并且随后将服务器上磁盘文件读取拼接成报文发送给浏览器，浏览器作为回应发送ACK告诉服务器”我收到你的响应了“

再然后是8-11，浏览器解析HTML文本后，发现其他资源需要请求，于是又走了一个请求的流程，和4-8方式相同，只不过因为没有图标文件返回的是404.	

![抓包示意图](https://blog-1258030304.cos.ap-guangzhou.myqcloud.com/books/master-http/packs-for-ip.jpeg)

## 使用域名访问Web服务器

基于上一节在hosts中的配置，我们再浏览器地址直接访问`http://www.chronom.com/`。

发现抓取的包并没有什么不同，那是因为浏览器会去hosts文件中查找域名对应的ip地址。

![hosts文件](https://blog-1258030304.cos.ap-guangzhou.myqcloud.com/books/master-http/dns-base-on-hosts.jpeg)

## 真实的网络世界

![真实的网络世界](https://blog-1258030304.cos.ap-guangzhou.myqcloud.com/books/master-http/real-network-world.jpeg)

上网设备可能是台式机由交换机接入固定网络，也可能是移动设备、平板通过蜂窝网络、WIFI由电信基站、无线热点接入移动网络。

接入网络会分配一个IP地址给你，可能是静态的，也可能是动态分配的（每次都变）。

你使用域名访问了一个网站，域名解析会先从操作系统缓存、本地hosts文件、根DNS、顶级DNS、权威DNS层层解析。

CDN可嫩个会在DNS解析中插一脚，因为DNS可能解析出DNS的IP地址，这样实际上拿到的就是CDN服务器的地址。

如果没有经过CDN，那么请求经过长途跋涉，经过路由器，网关，代理，最后到达目的地。

为了抗住高并发，服务器对外表现虽然是一个IP地址，但通常是负载均衡的设备，例如四层LVS或七层的Nginx。

负载均衡设备先访问缓存服务器，通常有memory级别缓存的Redis和disk级缓存的Varnish。

如果缓存的服务器额没有那么负载均衡就把请求转发给应用服务器了。

各种开发框架大显神通，再由访问数据库，把执行结果返回给负债均衡设备而，也可能在缓存服务器里存一份。

请求完成，会按照原路走回去，这个时候资源如果允许缓存，那么经过CDN的时候，也做缓存。

响应数据到达了你的设备而，被解析处理，如果有其他的资源又被引用到，又会重新走一遍整个流程。


