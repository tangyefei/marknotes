# 30 HTTP/2特性概览

HTTP的两个主要缺点是，不安全、性能不高。

HTTPS通过引入TLS/SSL解决了安全的问题。

但性能上，只是通过”长连接“优化了握手的环节，整体的数据传输没有更好的改进方案。

Googe发明了SPDY协议并应用于Chrome，随着IEFT以SPDY为基础，综合各家提出的意见推出了HTTP/1的继任者。

它就是本节的主题HTTP/2，在性能方面有了了巨大的飞跃。

## 为什么不是HTTP/2.0

工作组的解释是小版本好容易难以区分，所以在以后的HTTP协议中不再使用小版本号，只使用大版本号。

协议会在较长一段时间内保持稳定，发布新版本的HTTP协议时候会有本质的不同，而不是”零敲碎打“。

## 兼容HTTP/1.1

HTTPS在性能方面已经做的非常好，因此HTTP/2的唯一目标是改进性能。

为了不破坏物联网上现有的无数字长，必须要考虑好兼容，HTTP/2的做法是吧HTTP分惩恶”语义“和”语法“。

### 语义

语义层不做改动，与HTTP/1完全一致，消除了学习的成本，HTTP的上层应用不用做任何更改就可以切换到HTTP/2

### 语法

在语法层，HTTP/2做了”天翻地覆“的改造，完全变更了HTTP报文的传输格式。

## 头部压缩

HTTP/1.1可以通过Content-Encoding制定Body的编码方式，但是header部分却没有针对它的优化手段。

报文的header携带的许多固定头字段多达几百甚至上千字节，Body请求却通常只有几十字节（比如GET请求、204 No Content/301 Move Permanently/304 Not Modified）；另外一方面，很多终端都是重复的，导致了大量带宽浪费在了这些冗余上。

HTTP/2的优化方式是压缩，它专门开发了"HPACK"算法，在客户端和服务端建立字典，索引号表示重复的字符串，还采用哈夫曼编码来压缩整数和字符串，可以达到50%-90%的压缩率。

## 二进制格式

HTTP/1纯文本形式的报文优点是”一目了然“，开发调试都非常方便。HTTP/2的做法是不在会用肉眼可见的ASCII，而是全面采用二进制格式。原来使用纯文本容易出现多义性，比如大小写、空白字符、回车换行、多字少子等，程序处理需要使用使用复杂的计算机，效率低还麻烦，使用了二进制以后，严格规定字段大小、顺序、标志位等格式，解析起来没有歧义，实现简单，而且体积小 、速度快。

在二进制的基础上，它把TCP协议的部分特性挪到了应用层，把Header+Body的消息结构打散为数个小片的二进制”帧”，HEADERS帧存放头数据，DATA帧存放实体数据。

![HTTP2应用层按帧传递数据](http2-frame-pass.jpeg)

注：流浪器仍旧可以看到明文，是因为它对二进制做了转化。

## 虚拟的流

HTTP/2把一个一个的消息碎片叫做流（Stream），它是二进制帧的双向传输序列，每个帧分配唯一的ID，接收方按照次序将数据帧组装起来就是请求报文和响应报文。

所以一个TCP连接可以同时发送多个“碎片化”的消息，这就是常说的多路复用（Multiplexing）。

多个请求/响应之间没有了顺序关系，不需要排队等待，就不会出现"队头阻塞"的问题，降低了延迟，提高了连接的利用率。
=]
**思考：那么多路的多体现在哪里呢？多个请求/响应之间没有了顺序关系又怎么理解？**

![多路复用示意图](http2-multiplexing.jpeg)

HTTP/2还增加了一些空指针啦管理“流”，实现优先级和流量控制，这些协议和TCP协议非常类似。

HTTP/2在一定程度上改变了传统的“请求-应答”的工作模式，服务器不只是被动地响应请求，可以新建“流”主动向客户端发送消息。比如请求HTML的时候，就把可能会用到的JS、CSS文件发送个客户端，这被称为“服务器推送“。

思考：对于对头阻塞、多路复用的理解还不是和够？

## 强化安全

HTTP/2延续了HTTP/1.1的明文特点，不过格式是不需要解密的二进制。

因为HTTPS是大势所趋，所以互联网上的HTTP/2都是使用HTTPS的域名，跑在TLS上面。

为了区分在HTTPS上的加密版本HTTP/2和在HTTP上的明文HTTP/2，HTTP/2规定了连个字符串标识符：h2表示加密的，h2表示clear text的。

HTTP/2制定的时候，很多SSL/TLS的弱点已经发发现，而TLS还未发布，因此HTTP/2要求下层通信协议必须是TLS1.2以上，这也就废止了一些安全性很弱的密码套件。

## 协议栈


![http-https-http2-compare](http-https-http2-compare.jpeg)

## 课后作业

1. 明文形式HTTP/2有什么好处，应该如何使用？

	答：在一些对安全性要求不那么高的地方，采用HTTP2可以有更好的性能表现。比如内网。

2. 应该怎么理解HTTP/2里的”流“，为什么它是虚拟的？

	答：分片传输的，但是最终都要按照顺序组装，就想是顺序到达的水流一样，实际上它又是没有顺序的，因此说是虚拟的。


3. 对比下HTTP/2和HTTP/1、HTTPS的相同点和不同点？

	相同点：

	都是构筑在TCP/IP协议之上

	不同点：

	- HTTP明文传输，没有安全校验机制
	- HTTPS增加了SSL/TLS增加安全性
	- HTTPS/2引入了二进制、压缩请求头、帧分开传输来提高性能，可以在SSL/TLS层之上进一步提高安全性变化，还能服务器推送

	
	

