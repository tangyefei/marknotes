# 25 数字签名与证书

上一节通过加密实现了机密性，但是完整性、身份认证的问题仍然存在。

试想，黑客虽然没有回话密钥，但是可以窃的密文，然后进行修改后发送给通信一方。最后多次往返，再逐渐推断出线索。

另外，黑客伪造发布了公钥，你以为你在跟服务器通信，其实完全是跟客户在交换关键数据，这是身份认证的问题。

## 摘要算法

实现完整性主要依靠摘要算法，它可以把任意数据雅俗成固定长度、且独一无二的字符串，就想给这段数据生成了指纹。

摘要算法是特殊的单向加密算法，只有算法没有密钥，加密后的数据无法解密，不能反解出原文。

在工作中最长用到的两个摘要算法是 MD5、SHA-A，因为安全等级低已经在TLS中被禁止使用了，TLS推荐的是SHA-2。

SHA-2是一系列摘要算法的统称，常用的有SHA224 SHA256 SHA384，分别能生成28、32、48字节的摘要。

## 完整性

因为摘要算法保证和原文的完全等价，只要在原文后附上摘要，黑客哪怕动了其中一个标点符号，也能说明消息补鞥诶篡改了。

但摘要算法不具有机密性，如果明文传输，黑盒会连同原文+摘要一起都改了，因此必须要用会话密钥加密消息和摘要。

## 数字签名

信息私密，内容完整，下一个漏洞就在通信的双方的身份认证上了。

在前述例子中，唯一可以由本人持有，任何其他人都不会持有的就是**私钥**。

数字签名的原理就是，使用私钥加密原文的摘要得到签名，任何人都可以获取签名，但是只有私钥对应的公钥才能解开。

拿到摘要后，在对比原文验证完整性，就可以证明消息确实是你发的。

注：通信的双方都有自己的私钥，数字签名都是一方用私钥加密摘要得到签名，另一方用公钥解密得到摘要，然后对比完整性中的摘要。

![数字签名流程图](https://blog-1258030304.cos.ap-guangzhou.myqcloud.com/books/master-http/digital-signature.jpeg)

## 数字证书和CA

基本已经解决了安全相关四个问题，还有一个“公钥的信任”的问题，因为谁都可以发布公钥，你无法防止黑客伪造公钥。

通过引入CA（证书认证机构），它会基于序列号、用途、颁发者、有效期等信息，完整地证明公钥关联的各种信息，形成数字证书。

知名的CA全世界就几家，签发的证书分为DV、OV、EV，区别在于可信程度。

![证书链条](https://blog-1258030304.cos.ap-guangzhou.myqcloud.com/books/master-http/certificate-tree.jpeg)

小一点的CA为了让自己可信，也会找大一点的CA认证，最后会形成一个链条，最顶上叫Root CA。

操作系统和浏览器上都内置了各大CA的跟证书，上网时服务器发送过来的证书，会顺着链条层层验证，最后找到Root CA表明可信。

## 证书体系的弱点

如果CA失误或被欺骗，签发了错误的证书，虽然证书是真的，代表的网站却是假的，更危险的是CA被黑客攻陷。

针对第一类问题，开发出了CRL（证书吊销列表）和OCSP（在线证书状态协议），及时废止有问题的证书。

对于第二种问题，这小对CA的信任，加入黑名单，这样它办法的所有证书都会被认为是不安全的。











