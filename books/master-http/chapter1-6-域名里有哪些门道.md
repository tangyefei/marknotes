# 6 域名里有哪些门道？

IP协议的职责是“网际互联”，它在Mac之上使用IP地址把Mac编号转化为了四位数字，虽然它比Mac的16进制要好一点，但是难于记忆和输入。于是出现了DNS域名系统，在IP地址之上再来一次抽象。


## 域名的形式

域名大小写无关，但通常使用小写的形式，它使用一连串的用'.'分隔的单词组成，最右边成为定义域名，然后是二级域名，往左逐次降低。

过长的域名或者过多的层次会导致难于记忆，一般是两级或三级，四级的很少见。


为了方便记忆，最左边通常用于表示主机名，通常用于表示主机的用途，比如www表示万维网服务、mail表示邮件服务，不过这也不是绝对的，规则自己定，只要好记就行。

域名的用途除了替代IP地址，还可以在Nginx这样的Web服务器里，用来标识虚拟主机，决定由哪个虚拟主机来提供服务。

```
{
	listen： 80
	server_name: time.geekbang.org
}
```

还可以把它当做名字空间系统，比如国家、地区、组织、公司、部门，每个域名都是独一无二。

像Java的包机制就是使用了域名作为命名空间，只不过序列式反过来的。




## 域名的解析


![协议栈的工作方式](https://blog-1258030304.cos.ap-guangzhou.myqcloud.com/books/master-http/http-dns-analysis.jpeg)

DNS的核心系统是一个三层的分布式服务：

- 根级域名服务器（Root），返回com net cn等顶级域名服务器的ip地址
- 顶级域名服务器（Top-level)，返回域名下的权威域名服务器底子，比如com可以返回apple.com的ip地址
- 权威域名服务器(Authorirative)，管理域名主机下ip地址，比如apple.com可以返回www.apple.com的ip地址

全世界共有13根级域名服务器，又数百台映像，保证一定能被访问到。

查找的流程就是从树形结构里从顶至下查找，最终就获得了域名对应的ip地址。

但是如果所有的网络访问都想找个DNS系统里挤很容易瘫痪，因此除了核心DNS系统外，还有两种缓存手段用于减轻域名解析的压力。

### 大公司网络服务商自建DNS服务器

作为用户DNS查询代理，代理用户访问核心DNS系统，它们可以缓存之前查询过的结果，如果之前缓存过，就无需再向根服务器发起查询，直接返回对应的ip地址。

它们的特点是数量狠毒，并且部署在离用户很近的地方，比较知名的DNS有Google的8.8.8.8，微软的4.2.2.1等。

### 操作系统对DNS解析结果做缓存

操作系统同样对解析结果做了缓存，再一次在浏览器上输入地址的时候，就会直接拿到IP地址。

另外操作系统还有一个可编辑的“主机映射”文件，操作系统在缓存里找不到DNS记录，就会查找这个文件，它在Linux下的表示是 /etc/hosts。


综上，结合上述两种缓存策略，域名解析工作效率得到了提升。


![协议栈的工作方式](https://blog-1258030304.cos.ap-guangzhou.myqcloud.com/books/master-http/http-dns-structure.jpeg)



## 域名的新玩法

### 重定向

因为域名代替了IP地址，我们需要下线迁移时候，只需要修改DNS记录即可，让域名指向其他的服务器。

### 名字作为服务器

可以使用个开源软件搭建内部使用的DNS，开发的各种服务就用域名来标记。

### 基于域名实现负载均衡

域名解析可以返回多个ip地址，客户端收到多个地址可以字使用轮训算法，依次想多个服务器发送请求，实现负载均衡。

域名解析还可以策略，返回离客户单最近的或服务质量最好的主机，从而实现负载均衡。

负载均衡既可以用在内网，也可以用在外网。

### 恶意DNS

有一些恶意的玩法，比如：

- 域名屏蔽，对域名直接不解析或者返回错误，防火墙做的就是这样一个事
- 域名劫持，返回A，DNS却给你B


## 问答

1. 输入不存在的域名，解释一下它的DNS解析过程

	操作系统缓存 > 本地hosts文件 -> 非核心DNS服务器 -> 根域名服务器 -> 顶级域名服务器 -> 权威域名服务器

2. DNS失效或者出错了，会出现什么后果

	访问不到页面






























