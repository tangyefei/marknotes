# 33 我应该迁移到HTT/2吗？

各大科技巨头并没有像HTTPS那样给到HTTP/2那么多资源的支持，知道今天还处于不温不火的状态，它的普及速度远不及HTTPS。

## HTTP/2的优点

最大的有点事完全和HTTP/1兼容，并且安全于性能兼顾。

注：记录的较为粗略。

## HTTP/2的缺点

HTTP/2针对一个域名只开连接，它在TCP级别还是存在”队头阻塞“的问题。

注：需要结合HTTP/3和对队头阻塞的理解再更新。

## 应该迁移到HTTP/2吗

Top1000的王赞有40%的流量运行在HTTP/2上，充分说明了它的价值。

它的优势在于性能，选择时候主要是依据此，如果流量很大流量那么使用HTTP/2的收益可观，反之基于HTTP进行优化即可。

作者建议是，如果新网站，可以直接使用HTTP/2，以后也不会有迁移的烦恼，而且以后HTTP/3时代到来的时候更有优势。

## 配置HTTP/2

在listen中简单地通过一个 http2 标记即可启用http2。

服务器推送配置虽然容易，但是你需要自己去摸索，什么资源需要推送。

优化方面的HTTPS的一些策略仍旧适用，还有一些优化手段在HTTP/2是不适用的，还会有反效果，比如：雪碧图、资源内联、域名肺片等。

**思考：为什么？摘录网友的回答：**

> 因为HTTP/2中使用小颗粒化的资源，优化了缓存，而使用精灵图就相当于传输大文件，但是大文件会延迟客户端的处理执行，并且缓存失效的开销很昂贵，很少数量的数据更新就会使整个精灵图失效，需要重新下载(http1中使用精灵图是为了减少请求)；
HTTP1中使用内联资源也是为了减少请求，内联资源没有办法独立缓存，破坏了HTTP/2的多路复用和优先级策略；
域名分片在HTTP1中是为了突破浏览器每个域名下同时连接数，但是这在HTTP/2中使用多路复用解决了这个问题，如果使用域名分片反而会限制HTTP2的自由发挥



HTTP2默认启用头压缩，如果没有启用body压缩，需要自己在Nginx中配置gzip指令，压缩HTML、JS等文本数据。


## 应用层协议协商（ALPN)

浏览器如何知道访问的网址是否支持HTTP/2呢？在TLS的扩展里有一个ALPN（Application Layer  Protocol Negotiation)用来与服务器协商使用什么应用协议。

客户端发起"Client Hello"的时候，会邪恶带一个ALPN扩展，包含按照优先级顺序列出的客户端支持的应用协议。

服务器看到后会从列表中选择一个应用协议，并且在 S而ever Hello中告诉要使用哪一种。

